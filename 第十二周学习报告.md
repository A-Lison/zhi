## JS高阶-异步

### 初步理解异步-单线程&多线程

定义： Javascript语言的执行环境是单线程。即一次只能完成一个任务。若有多个任务则需排队逐个执行——前一个任务完成，再执行后一个任务。

为避免和解决这种问题，JS语言将任务执行模式分为异步和同步。同步模式”就是上一段的模式，后一个任务等待前一个任务结束，然后再执行；”异步模式”则完全不同，每一个任务有一个或多个回调函数（callback），前一个任务结束后，不是执行后一个任务，而是执行回调函数，后一个任务则是不等前一个任务结束就执行，所以程序的执行顺序与任务的排列顺序是不一致的、异步的。

------

- 回调函数是异步编程常用的模式。
- 异步模式中，主函数不必等回调函数执行完了再去执行，可以先执行主调函数。
- 一般回调函数都用在耗时操作上面。比如ajax请求，比如处理文件等。

```
//定义主函数，回调函数作为参数
function A(callback) {
    callback();  
    console.log('我是主函数');      
}
 
//定义回调函数
function B(){
    setTimeout("console.log('我是回调函数')", 3000);//模仿耗时操作  
}
 
//调用主函数，将函数B传进去
A(B);
 
//输出结果
我是主函数
我是回调函数
 
```

补充回调函数应用场合和优缺点：

- 资源加载：动态加载js文件后执行回调，加载iframe后执行回调，ajax操作回调，图片加载完成执行回调，AJAX等等。
- DOM事件及Node.js事件基于回调机制(Node.js回调可能会出现多层回调嵌套的问题)。
- setTimeout的延迟时间为0，这个hack经常被用到，settimeout调用的函数其实就是一个callback的体现。
- 链式调用：链式调用的时候，在赋值器(setter)方法中(或者本身没有返回值的方法中)很容易实现链式调用，而取值器(getter)相对来说不好实现链式调用，因为你需要取值器返回你需要的数据而不是this指针，如果要实现链式方法，可以用回调函数来实现。
- setTimeout、setInterval的函数调用得到其返回值。由于两个函数都是异步的，即：他们的调用时序和程序的主流程是相对独立的，所以没有办法在主体里面等待它们的返回值，它们被打开的时候程序也不会停下来等待，否则也就失去了setTimeout及setInterval的意义了，所以用return已经没有意义，只能使用callback。callback的意义在于将timer执行的结果通知给代理函数进行及时处理。

## promise

理解：为了让编程更美好，我们就需要引入`promise`来降低异步编程的复杂性。所以某种程度上说，promise是对上面说到的回调函数处理异步编程的一个进阶方案。Promise的思想是，每一个异步任务返回一个Promise对象，该对象有一个then方法，允许指定回调函数。

Promise也代表了某种承诺，即无论你异步操作成功与否，这个对象最终都会返回一个值



## this定义

### 定义

1. 任何函数本质上都是通过某个对象来调用，如果没有指定就是window
2. 所有函数内部都有一个变量this
3. 它的值是调用函数的当前对象

### 确定this的值

1. test(); window
2. p.test(); p
3. new test(); 新创建的对象
4. p.call(obj); obj
   - 在方法中，this 表示该方法所属的对象。
   - 如果单独使用，this 表示全局对象。
   - 在函数中，this 表示全局对象。
   - 在函数中，在严格模式下，this 是未定义的(undefined)。
   - 在事件中，this 表示接收事件的元素。

### 一个运用this的隐藏方法（藏）

this的行内绑定

```
<h2>JavaScript this</h2>
<button onclick="this.style.display='none'">黑魔法消失术</button>
```

